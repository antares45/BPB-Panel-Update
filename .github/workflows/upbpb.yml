# å·¥ä½œæµåç§°
name: Update Worker

# è§¦å‘æ¡ä»¶
on:
workflow_dispatch:
inputs:
force_update:
description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
required: false
default: 'false'
schedule:
- cron: "0 1 * * *"

# æƒé™è®¾ç½®
permissions:
contents: write

# å·¥ä½œæµä»»åŠ¡
jobs:
update:
runs-on: ubuntu-latest
steps:
# æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
- name: æ£€å‡ºä»“åº“
uses: actions/checkout@v4
with:
fetch-depth: 0

# æ­¥éª¤ 2: å®‰è£…ä¾èµ–å·¥å…·
- name: å®‰è£…ä¾èµ–å·¥å…·
run: |
echo "å®‰è£… jqã€wget å’Œ unzip..."
sudo apt-get update -y
sudo apt-get install -y jq wget unzip
jq --version || { echo "é”™è¯¯: jq å®‰è£…å¤±è´¥"; exit 1; }
wget --version || { echo "é”™è¯¯: wget å®‰è£…å¤±è´¥"; exit 1; }
unzip -v || { echo "é”™è¯¯: unzip å®‰è£…å¤±è´¥"; exit 1; }

# æ­¥éª¤ 3: è®¾ç½®ç¯å¢ƒå˜é‡
- name: è®¾ç½®ç¯å¢ƒå˜é‡
run: |
echo "REPO_URL=https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases" >> $GITHUB_ENV
echo "TARGET_FILE=worker.zip" >> $GITHUB_ENV
echo "DEBUG=true" >> $GITHUB_ENV

# æ­¥éª¤ 4: æ£€æŸ¥å¹¶æ›´æ–° Worker
- name: æ£€æŸ¥å¹¶æ›´æ–° Worker
env:
GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
run: |
# å®šä¹‰æ—¥å¿—å‡½æ•°
log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

log "å¼€å§‹æ£€æŸ¥æ›´æ–°..."

# è¾“å‡ºç¯å¢ƒä¿¡æ¯
log "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
log "æ–‡ä»¶åˆ—è¡¨:"
ls -la

# æ£€æŸ¥ GITHUB_TOKEN æ˜¯å¦å­˜åœ¨
if [ -z "$GITHUB_TOKEN" ]; then
log "é”™è¯¯: GITHUB_TOKEN æœªè®¾ç½®"
exit 1
fi

# è·å–æœ¬åœ°ç‰ˆæœ¬
LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "none")
log "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"

# è·å–æœ€æ–° Release ä¿¡æ¯
log "è¯·æ±‚ GitHub API: $REPO_URL"
RESPONSE=$(curl -s --retry 5 --retry-delay 2 -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$REPO_URL")
CURL_EXIT_CODE=$?
if [ $CURL_EXIT_CODE -ne 0 ]; then
log "é”™è¯¯: curl è¯·æ±‚å¤±è´¥ï¼Œé€€å‡ºä»£ç : $CURL_EXIT_CODE"
exit 1
fi
if [ -z "$RESPONSE" ]; then
log "é”™è¯¯: GitHub API è¿”å›ç©ºå“åº”"
exit 1
fi

# è°ƒè¯•ï¼šè¾“å‡º API å“åº”æ‘˜è¦
if [ "$DEBUG" = "true" ]; then
log "è°ƒè¯•: API å“åº”å‰ 200 å­—ç¬¦"
echo "${RESPONSE:0:200}"
fi

# æ£€æŸ¥ API å“åº”æ˜¯å¦ä¸ºæœ‰æ•ˆ JSON
echo "$RESPONSE" | jq -r 'type' 2>/dev/null | grep -q "array" || { log "é”™è¯¯: API å“åº”ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ•°ç»„"; exit 1; }

# æå–æœ€æ–°ç‰ˆæœ¬å·
TAG_NAME=$(echo "$RESPONSE" | jq -r '.[0].tag_name' 2>/dev/null)
if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
log "é”™è¯¯: æ— æ³•æå–ç‰ˆæœ¬å·"
exit 1
fi
log "æœ€æ–°ç‰ˆæœ¬: $TAG_NAME"

# æå–ä¸‹è½½é“¾æ¥
DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.[0].assets[] | select(.name == "'"$TARGET_FILE"'") | .browser_download_url' 2>/dev/null)
if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
log "é”™è¯¯: æœªæ‰¾åˆ° $TARGET_FILE"
log "å¯ç”¨èµ„äº§:"
echo "$RESPONSE" | jq -r '.[0].assets[].name'
exit 1
fi
log "ä¸‹è½½é“¾æ¥: $DOWNLOAD_URL"

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
if [ "$LOCAL_VERSION" = "$TAG_NAME" ] && [ "$FORCE_UPDATE" != "true" ]; then
log "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
exit 0
fi

# ä¸‹è½½æ–‡ä»¶
log "ä¸‹è½½ $TARGET_FILE..."
wget -q --tries=3 -O "$TARGET_FILE" "$DOWNLOAD_URL" || { log "é”™è¯¯: ä¸‹è½½ $TARGET_FILE å¤±è´¥"; exit 1; }

# éªŒè¯ä¸‹è½½æ–‡ä»¶
if [ ! -f "$TARGET_FILE" ]; then
log "é”™è¯¯: $TARGET_FILE æœªä¸‹è½½æˆåŠŸ"
exit 1
fi
log "æ–‡ä»¶å¤§å°: $(ls -lh $TARGET_FILE | awk '{print $5}')"

# è§£å‹æ–‡ä»¶
log "è§£å‹ $TARGET_FILE..."
unzip -o "$TARGET_FILE" || { log "é”™è¯¯: è§£å‹ $TARGET_FILE å¤±è´¥"; exit 1; }
rm "$TARGET_FILE"

# æ›´æ–°ç‰ˆæœ¬å·
echo "$TAG_NAME" > version.txt
log "æ›´æ–°å®Œæˆï¼Œæ–°ç‰ˆæœ¬: $TAG_NAME"

# æ­¥éª¤ 5: æäº¤æ›´æ”¹
- name: æäº¤æ›´æ”¹
if: success()
uses: stefanzweifel/git-auto-commit-action@v5
with:
commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬: ${{ env.TAG_NAME || 'æœªçŸ¥' }}"
commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
