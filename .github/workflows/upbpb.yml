# å·¥ä½œæµåç§°
name: Update Worker

# è§¦å‘æ¡ä»¶
on:
# æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
workflow_dispatch:
inputs:
force_update:
description: 'Force update (ignore version check)'
required: false
default: 'false'
# å®šæ—¶è§¦å‘ï¼Œæ¯å¤© UTC æ—¶é—´å‡Œæ™¨ 1 ç‚¹
schedule:
- cron: "0 1 * * *"

# æƒé™è®¾ç½®
permissions:
contents: write # å…è®¸å·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹

# å·¥ä½œæµä»»åŠ¡
jobs:
update:
runs-on: ubuntu-latest
steps:
# æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç 
- name: Checkout repository
uses: actions/checkout@v4

# æ­¥éª¤ 2: å®‰è£…ä¾èµ–å·¥å…·ï¼ˆjqã€wgetã€unzipï¼‰
- name: Install dependencies
run: |
sudo apt-get update
sudo apt-get install -y jq wget unzip

# æ­¥éª¤ 3: è®¾ç½®ç¯å¢ƒå˜é‡
- name: Set environment variables
run: |
echo "REPO_URL=https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases" >> $GITHUB_ENV
echo "TARGET_FILE=worker.zip" >> $GITHUB_ENV

# æ­¥éª¤ 4: æ£€æŸ¥å¹¶æ›´æ–° Worker
- name: Check and update Worker
env:
GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
run: |
# å®šä¹‰æ—¥å¿—å‡½æ•°
log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

log "Starting update check..."

# æ£€æŸ¥å¿…è¦å·¥å…·æ˜¯å¦å­˜åœ¨
command -v jq >/dev/null 2>&1 || { log "Error: jq not found"; exit 1; }
command -v wget >/dev/null 2>&1 || { log "Error: wget not found"; exit 1; }
command -v unzip >/dev/null 2>&1 || { log "Error: unzip not found"; exit 1; }

# è·å–æœ¬åœ°ç‰ˆæœ¬
LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "none")
log "Local version: $LOCAL_VERSION"

# è·å–æœ€æ–° Release ä¿¡æ¯
log "Fetching latest release info..."
RESPONSE=$(curl -s --retry 3 -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$REPO_URL")
if [ $? -ne 0 ]; then
log "Error: Failed to access GitHub API"
exit 1
fi

# æ£€æŸ¥ API å“åº”æ˜¯å¦æœ‰æ•ˆ
if [ -z "$RESPONSE" ] || [ "$(echo "$RESPONSE" | jq -r 'type')" != "array" ]; then
log "Error: Invalid GitHub API response"
exit 1
fi

# æå–æœ€æ–°ç‰ˆæœ¬å·å’Œä¸‹è½½é“¾æ¥
TAG_NAME=$(echo "$RESPONSE" | jq -r '.[0].tag_name')
DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.[0].assets[] | select(.name == "'"$TARGET_FILE"'") | .browser_download_url')

# æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°ä¸‹è½½é“¾æ¥
if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
log "Error: $TARGET_FILE not found in latest release"
exit 1
fi
log "Latest version: $TAG_NAME"

# åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
if [ "$LOCAL_VERSION" = "$TAG_NAME" ] && [ "$FORCE_UPDATE" != "true" ]; then
log "Already up-to-date, no update needed"
exit 0
fi

# ä¸‹è½½å¹¶æ›´æ–°æ–‡ä»¶
log "Downloading $TARGET_FILE..."
wget -q -O "$TARGET_FILE" "$DOWNLOAD_URL" || { log "Error: Failed to download $TARGET_FILE"; exit 1; }
log "Unzipping $TARGET_FILE..."
unzip -o "$TARGET_FILE" || { log "Error: Failed to unzip $TARGET_FILE"; exit 1; }
rm "$TARGET_FILE"
echo "$TAG_NAME" > version.txt
log "Update completed, new version: $TAG_NAME"

# æ­¥éª¤ 5: æäº¤æ›´æ”¹
- name: Commit changes
if: success()
uses: stefanzweifel/git-auto-commit-action@v5
with:
commit_message: "ğŸ”„ Auto-sync Worker version: ${{ steps.check_update.outputs.tag_name || 'unknown' }}"
commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
